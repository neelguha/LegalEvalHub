{% extends "base.html" %}

{% block title %}{{ preset_data.name }} - LegalEvalHub{% endblock %}

{% block content %}
<article class="documentation">
    <h2>{{ preset_data.name }}</h2>
    
    {{ preset_data.description|safe }}
    <br>
    <br>
    {% set is_single_task = selected_tasks|length == 1 %}
    {% if not is_single_task %}
    <p class="note"><em>Note: Only models that have been evaluated on all {{ selected_tasks|length }} tasks in this preset are included in the leaderboard.</em></p>
    <br>
    {% endif %}
    
    {% if is_single_task and selected_tasks[0] %}
        {# For single-task leaderboards, show the same table as the task detail page #}
        {% set task = selected_tasks[0] %}
        {% if single_task_leaderboard %}
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Model</th>
                    {% for metric in task.metrics %}
                    <th>{{ metric.name }}</th>
                    {% endfor %}
                    <th>Date</th>
                    <th>Results</th>
                </tr>
            </thead>
            <tbody>
                {% for run in single_task_leaderboard %}
                <tr>
                    <td class="rank">{{ run.rank }}</td>
                    <td>{{ run.model_name }}</td> 
                    {% for metric in task.metrics %}
                    <td class="metric-value">{{ "%.3f"|format(run.metrics.get(metric.name, 0)) }}</td>
                    {% endfor %}
                    <td>{{ run.submission_time[:10] }}</td>
                    <td><a href="{{ run.predictions_url }}" target="_blank">View</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No submissions yet for this task.</p>
        {% endif %}
    
    {% elif leaderboard %}
        {# For multi-task leaderboards, show the aggregate view #}
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th class="sortable" data-sort="model">Model <span class="sort-arrow"></span></th>
                    <th class="sortable" data-sort="wins">Wins <span class="sort-arrow"></span></th>
                    <th class="sortable" data-sort="avg_rank">Average Rank <span class="sort-arrow"></span></th>
                    <th class="sortable" data-sort="raw_metric">Raw Metric Avg <span class="sort-arrow"></span></th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in leaderboard %}
                <tr class="model-row" data-model-index="{{ loop.index0 }}" 
                    data-model="{{ entry.model }}" 
                    data-wins="{{ entry.wins }}" 
                    data-avg-rank="{{ entry.avg_rank }}" 
                    data-raw-metric="{{ entry.avg_raw_metric }}">
                    <td class="rank-cell">{{ loop.index }}</td>
                    <td class="model-name">{{ entry.model }}</td>
                    <td><strong>{{ entry.wins }}</strong></td>
                    <td>{{ "%.2f"|format(entry.avg_rank) }}</td>
                    <td>{{ "%.4f"|format(entry.avg_raw_metric) }}</td>
                    <td><span class="expand-icon">▶</span></td>
                </tr>
                <tr class="detail-row" id="details-{{ loop.index0 }}" style="display: none;">
                    <td colspan="6">
                        <div class="task-breakdown">
                            <h4>Task-by-Task Performance for {{ entry.model }}</h4>
                            <table class="task-detail-table">
                                <thead>
                                    <tr>
                                        <th>Task</th>
                                        <th>Rank</th>
                                        <th>Score</th>
                                        <th>Metric</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for run in entry.runs %}
                                    <tr>
                                        <td><a href="{{ url_for('task_detail', task_id=run.task_id) }}">{{ run.task_name }}</a></td>
                                        <td class="rank">{{ run.rank }}</td>
                                        <td class="metric-value">{{ "%.4f"|format(run.score) }}</td>
                                        <td class="small">{{ run.metric }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
    <p class="text-muted">No evaluation results available for this preset yet.</p>
    {% endif %}

    <h2>Tasks in This Benchmark</h2>
    
    <ul class="task-list">
        {% for task in selected_tasks %}
        <li><a href="{{ url_for('task_detail', task_id=task.task_id) }}">{{ task.name }}</a></li>
        {% endfor %}
    </ul>
</article>

<style>
.note {
    background-color: #e8f4f8;
    border-left: 4px solid #0066cc;
    padding: 0.75rem 1rem;
    margin: 1rem 0;
    font-size: 0.95rem;
}

.lead {
    font-size: 1.2em;
    color: #333;
    margin-bottom: 1.5rem;
}

.preset-info {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 2rem;
}

.task-list {
    list-style-type: disc;
    padding-left: 1.5rem;
    margin: 1rem 0;
}

.task-list li {
    margin-bottom: 0.5rem;
    line-height: 1.6;
}

.preset-navigation {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
}

.preset-nav-item {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.preset-nav-item:hover {
    background: #f5f5f5;
}

.cta-section {
    margin-top: 3rem;
    padding: 1.5rem;
    background: #f0f7ff;
    border: 1px solid #0066cc;
    border-radius: 5px;
    text-align: center;
}

/* Expandable row styles */
.model-row {
    cursor: pointer;
}

.model-row:hover {
    background-color: #f5f5f5;
}

.expand-icon {
    transition: transform 0.2s;
    display: inline-block;
    font-size: 0.8em;
}

.model-row.expanded .expand-icon {
    transform: rotate(90deg);
}

.detail-row {
    background-color: #f8f9fa;
}

.task-breakdown {
    padding: 1rem;
}

.task-breakdown h4 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    color: #333;
}

.task-detail-table {
    margin: 0;
    font-size: 0.9rem;
}

.task-detail-table th {
    background-color: #e9ecef;
    font-size: 0.85rem;
}

.task-detail-table td {
    padding: 0.5rem;
}

.task-detail-table .rank {
    text-align: center;
    font-weight: 600;
}

/* Sortable table styles */
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    transition: background-color 0.2s;
}

.sortable:hover {
    background-color: #e3f2fd;
}

.sort-arrow {
    font-size: 0.7em;
    margin-left: 0.5rem;
    color: #999;
    transition: color 0.2s;
}

.sortable.sort-asc .sort-arrow:after {
    content: "▲";
    color: #333;
}

.sortable.sort-desc .sort-arrow:after {
    content: "▼";
    color: #333;
}

.sortable:not(.sort-asc):not(.sort-desc) .sort-arrow:after {
    content: "▲▼";
    font-size: 0.6em;
    opacity: 0.5;
}

/* Alternating row colors */
.model-row:nth-of-type(4n+1) {
    background-color: #f9f9f9;
}

.model-row:nth-of-type(4n+1) + .detail-row {
    background-color: #f9f9f9;
}

.model-row:nth-of-type(4n+3) {
    background-color: #ffffff;
}

.model-row:nth-of-type(4n+3) + .detail-row {
    background-color: #ffffff;
}

/* Ensure hover effects still work over alternating colors */
.model-row:hover {
    background-color: #e8f4f8 !important;
}

/* Keep existing detail row styling but adjust for alternating colors */
.detail-row {
    background-color: inherit;
}

.detail-row .task-breakdown {
    background-color: rgba(248, 249, 250, 0.8);
    border-radius: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modelRows = document.querySelectorAll('.model-row');
    const sortableHeaders = document.querySelectorAll('.sortable');
    const tbody = document.querySelector('table tbody');
    
    // Initialize alternating row colors
    function initializeRowColors() {
        const allModelRows = document.querySelectorAll('.model-row');
        allModelRows.forEach(function(row, index) {
            const detailRow = document.getElementById('details-' + row.getAttribute('data-model-index'));
            
            if (index % 2 === 0) {
                // Even index - light gray background
                row.style.backgroundColor = '#f9f9f9';
                if (detailRow) detailRow.style.backgroundColor = '#f9f9f9';
            } else {
                // Odd index - white background  
                row.style.backgroundColor = '#ffffff';
                if (detailRow) detailRow.style.backgroundColor = '#ffffff';
            }
        });
    }
    
    // Initialize colors on page load
    initializeRowColors();
    
    // Expand/collapse functionality
    modelRows.forEach(function(row) {
        row.addEventListener('click', function(e) {
            // Don't expand if clicking on a sortable header
            if (e.target.closest('.sortable')) return;
            
            const modelIndex = this.getAttribute('data-model-index');
            const detailRow = document.getElementById('details-' + modelIndex);
            
            if (detailRow.style.display === 'none') {
                detailRow.style.display = 'table-row';
                this.classList.add('expanded');
            } else {
                detailRow.style.display = 'none';
                this.classList.remove('expanded');
            }
        });
    });
    
    // Sorting functionality
    sortableHeaders.forEach(function(header) {
        header.addEventListener('click', function(e) {
            e.stopPropagation();
            const sortType = this.getAttribute('data-sort');
            const isAsc = this.classList.contains('sort-asc');
            
            // Clear all sort classes
            sortableHeaders.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
            
            // Set new sort direction
            if (isAsc) {
                this.classList.add('sort-desc');
            } else {
                this.classList.add('sort-asc');
            }
            
            // Get all row pairs (model row + detail row)
            const rowPairs = [];
            const allRows = Array.from(tbody.children);
            
            for (let i = 0; i < allRows.length; i += 2) {
                if (allRows[i] && allRows[i + 1]) {
                    rowPairs.push([allRows[i], allRows[i + 1]]);
                }
            }
            
            // Sort row pairs
            rowPairs.sort(function(a, b) {
                const rowA = a[0];
                const rowB = b[0];
                let valueA, valueB;
                
                switch(sortType) {
                    case 'model':
                        valueA = rowA.getAttribute('data-model').toLowerCase();
                        valueB = rowB.getAttribute('data-model').toLowerCase();
                        break;
                    case 'wins':
                        valueA = parseInt(rowA.getAttribute('data-wins'));
                        valueB = parseInt(rowB.getAttribute('data-wins'));
                        break;
                    case 'avg_rank':
                        valueA = parseFloat(rowA.getAttribute('data-avg-rank'));
                        valueB = parseFloat(rowB.getAttribute('data-avg-rank'));
                        break;
                    case 'raw_metric':
                        valueA = parseFloat(rowA.getAttribute('data-raw-metric'));
                        valueB = parseFloat(rowB.getAttribute('data-raw-metric'));
                        break;
                }
                
                if (valueA < valueB) return isAsc ? 1 : -1;
                if (valueA > valueB) return isAsc ? -1 : 1;
                return 0;
            });
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rowPairs.forEach(function(pair, index) {
                // Update rank numbers
                pair[0].querySelector('.rank-cell').textContent = index + 1;
                
                // Apply alternating row colors
                const modelRow = pair[0];
                const detailRow = pair[1];
                
                if (index % 2 === 0) {
                    // Even index - light gray background
                    modelRow.style.backgroundColor = '#f9f9f9';
                    detailRow.style.backgroundColor = '#f9f9f9';
                } else {
                    // Odd index - white background
                    modelRow.style.backgroundColor = '#ffffff';
                    detailRow.style.backgroundColor = '#ffffff';
                }
                
                tbody.appendChild(pair[0]);
                tbody.appendChild(pair[1]);
            });
            
            // Re-attach event listeners to new rows
            const newModelRows = document.querySelectorAll('.model-row');
            newModelRows.forEach(function(row) {
                row.addEventListener('click', function(e) {
                    if (e.target.closest('.sortable')) return;
                    
                    const modelIndex = this.getAttribute('data-model-index');
                    const detailRow = document.getElementById('details-' + modelIndex);
                    
                    if (detailRow.style.display === 'none') {
                        detailRow.style.display = 'table-row';
                        this.classList.add('expanded');
                    } else {
                        detailRow.style.display = 'none';
                        this.classList.remove('expanded');
                    }
                });
            });
        });
    });
});
</script>
{% endblock %}